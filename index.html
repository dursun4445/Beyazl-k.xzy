// PlayerCharacter.h
#pragma once
#include "CoreMinimal.h"
#include "GameFramework/Character.h"
#include "PlayerCharacter.generated.h"

class AWeapon;
class AZone;

UCLASS()
class DROPZONE_API APlayerCharacter : public ACharacter
{
    GENERATED_BODY()

public:
    APlayerCharacter();

protected:
    virtual void SetupPlayerInputComponent(class UInputComponent* PlayerInputComponent) override;

public:
    void MoveForward(float Value);
    void MoveRight(float Value);
    void StartSprint();
    void StopSprint();

    // Weapon
    void PickupWeapon(AWeapon* NewWeapon);
    AWeapon* CurrentWeapon;

    // Health
    float Health = 100.f;

    // Zone damage
    void CheckZone(AZone* Zone);
};

// PlayerCharacter.cpp
#include "PlayerCharacter.h"
#include "Weapon.h"
#include "Zone.h"
#include "GameFramework/CharacterMovementComponent.h"
#include "Kismet/GameplayStatics.h"

void APlayerCharacter::SetupPlayerInputComponent(UInputComponent* PlayerInput)
{
    PlayerInput->BindAxis("MoveForward", this, &APlayerCharacter::MoveForward);
    PlayerInput->BindAxis("MoveRight", this, &APlayerCharacter::MoveRight);
    PlayerInput->BindAction("Sprint", IE_Pressed, this, &APlayerCharacter::StartSprint);
    PlayerInput->BindAction("Sprint", IE_Released, this, &APlayerCharacter::StopSprint);
}

void APlayerCharacter::MoveForward(float Value) { AddMovementInput(GetActorForwardVector(), Value); }
void APlayerCharacter::MoveRight(float Value) { AddMovementInput(GetActorRightVector(), Value); }
void APlayerCharacter::StartSprint() { GetCharacterMovement()->MaxWalkSpeed = 700.f; }
void APlayerCharacter::StopSprint() { GetCharacterMovement()->MaxWalkSpeed = 400.f; }

void APlayerCharacter::PickupWeapon(AWeapon* NewWeapon)
{
    if (CurrentWeapon) CurrentWeapon->Destroy();
    CurrentWeapon = NewWeapon;
    CurrentWeapon->AttachToComponent(GetMesh(), FAttachmentTransformRules::SnapToTargetNotIncludingScale, "WeaponSocket");
}

void APlayerCharacter::CheckZone(AZone* Zone)
{
    if (!Zone->IsInside(GetActorLocation()))
        Health -= 1.f * GetWorld()->GetDeltaSeconds();
}

// Weapon.h
#pragma once
#include "CoreMinimal.h"
#include "GameFramework/Actor.h"
#include "Weapon.generated.h"

UCLASS()
class DROPZONE_API AWeapon : public AActor
{
    GENERATED_BODY()

public:
    int Ammo = 30;
    void Fire();

    UPROPERTY(VisibleAnywhere)
    USceneComponent* MuzzleLocation;
};

// Weapon.cpp
#include "Weapon.h"
#include "Kismet/GameplayStatics.h"

void AWeapon::Fire()
{
    if (Ammo <= 0) return;
    Ammo--;

    FVector Start = MuzzleLocation->GetComponentLocation();
    FVector End = Start + (GetOwner()->GetActorForwardVector() * 10000);
    FHitResult Hit;
    GetWorld()->LineTraceSingleByChannel(Hit, Start, End, ECC_Visibility);

    if (Hit.Actor.IsValid())
        UGameplayStatics::ApplyDamage(Hit.Actor.Get(), 25.f, nullptr, this, nullptr);
}

// Zone.h
#pragma once
#include "CoreMinimal.h"
#include "GameFramework/Actor.h"
#include "Zone.generated.h"

UCLASS()
class DROPZONE_API AZone : public AActor
{
    GENERATED_BODY()
public:
    float CurrentRadius = 3000.f;
    float ShrinkSpeed = 10.f;
    bool IsInside(FVector Location) { return FVector::Dist(GetActorLocation(), Location) <= CurrentRadius; }

    virtual void Tick(float DeltaTime) override;
    UPROPERTY(VisibleAnywhere)
    class USphereComponent* ZoneSphere;
};

// Zone.cpp
#include "Zone.h"
#include "Components/SphereComponent.h"

void AZone::Tick(float DeltaTime)
{
    Super::Tick(DeltaTime);
    CurrentRadius -= ShrinkSpeed * DeltaTime;
    ZoneSphere->SetSphereRadius(CurrentRadius);
}

// Plane.cpp (Uçaktan atlama)
void APlane::DropPlayer(APlayerCharacter* Player)
{
    FVector DropLocation = GetActorLocation();
    Player->SetActorLocation(DropLocation);
    Player->EnableParachute(); // Paraşüt animasyonu + fizik eklenecek
}

// AI Bot Basit
AIController->MoveToActor(Player, 300.f); // Player’ı takip eder
